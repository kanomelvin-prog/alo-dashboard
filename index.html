<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alo Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root { --cream: #FDFBF7; --sage: #8B9A7D; --stone: #9C9589; --charcoal: #2D2A26; --border: #E5E1DA; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: #F4F2EE; color: var(--charcoal); display: flex; height: 100vh; }
        aside { width: 320px; background: white; border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        header { padding: 1.5rem; border-bottom: 1px solid var(--border); }
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding: 1rem; background: var(--cream); }
        .stat-card { padding: 10px; text-align: center; border: 1px solid var(--border); border-radius: 4px; }
        .stat-val { font-weight: 600; font-size: 1.2rem; display: block; }
        .stat-lab { font-size: 0.7rem; color: var(--stone); text-transform: uppercase; }
        #client-list { flex-grow: 1; overflow-y: auto; }
        .client-item { padding: 1rem; border-bottom: 1px solid var(--border); cursor: pointer; }
        .client-item.active { border-left: 4px solid var(--sage); background: var(--cream); }
        main { flex-grow: 1; display: flex; flex-direction: column; background: white; }
        #chat-history { flex-grow: 1; overflow-y: auto; padding: 2rem; display: flex; flex-direction: column; gap: 1rem; }
        .message-bubble { padding: 1rem; border-radius: 8px; line-height: 1.5; max-width: 80%; }
        .user-msg { background: #f9f9f9; border: 1px solid var(--border); align-self: flex-start; }
        .alo-msg { background: var(--cream); border: 1px solid var(--sage); align-self: flex-end; }
        .intention-tag { background: var(--sage); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.65rem; text-transform: uppercase; }
    </style>
</head>
<body>
    <aside>
        <header><h2 style="margin:0; color:var(--sage)">Alo Dashboard</h2><p style="font-size:0.8rem; color:var(--stone)">Clinical Review Panel</p></header>
        <div class="stats-grid">
            <div class="stat-card"><span id="stat-total-users" class="stat-val">0</span><span class="stat-lab">Clients</span></div>
            <div class="stat-card"><span id="stat-total-turns" class="stat-val">0</span><span class="stat-lab">Turns</span></div>
        </div>
        <div id="client-list"></div>
    </aside>
    <main><div id="chat-history"><div style="text-align:center; color:var(--stone); margin-top:20%;">Select a client to review activity</div></div></main>

    <script>
        const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
        const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; 
        
        // Variable renamed to avoid 'already declared' error
        const aloClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let selectedUserId = null;

        async function loadData() {
            const { data, error } = await aloClient.from('conversation_turns').select('*').order('created_at', { ascending: false });
            if (error) return console.error(error);

            const users = [...new Set(data.map(t => t.user_id))];
            document.getElementById('stat-total-users').innerText = users.length;
            document.getElementById('stat-total-turns').innerText = data.length;

            const list = document.getElementById('client-list');
            list.innerHTML = users.map(u => `
                <div class="client-item ${u === selectedUserId ? 'active' : ''}" onclick="showUser('${u}')">
                    <div style="font-weight:500;">Client ...${u.slice(-6)}</div>
                </div>
            `).join('');

            if (selectedUserId) {
                const filtered = data.filter(t => t.user_id === selectedUserId).reverse();
                document.getElementById('chat-history').innerHTML = filtered.map(t => `
                    <div class="message-bubble user-msg">${t.user_message}</div>
                    <div class="message-bubble alo-msg">${t.alo_response} 
                        <div style="margin-top:5px;"><span class="intention-tag">${t.intention_used || 'General'}</span></div>
                    </div>
                `).join('');
            }
        }

        function showUser(id) { selectedUserId = id; loadData(); }
        loadData();
        setInterval(loadData, 30000);
    </script>
</body>
</html>
