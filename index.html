# Dashboard Updates - Messages & Editable Therapist Name
## Code Changes to Add

---

## PART 1: Add Messages Section to Homepage

### A. Add HTML Section (after Triage section, before sidebar)

**Find this in your dashboard.html:**
```html
      </div>
      <!-- End of Triage Section -->
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
```

**Add this NEW section between them:**
```html
      </div>
      
      <!-- Messages Section (NEW) -->
      <div class="section" id="messagesSection">
        <div class="section-header">
          <div class="section-icon" style="background: #eff6ff; color: #1e40af;">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <span class="section-title">Messages from Clients</span>
          <span class="section-count" id="messagesCount">0</span>
        </div>
        <div class="section-body" id="messagesList">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
```

---

## PART 2: Add Messages to Alo Activity Tab

### B. Update Alo Activity Tab Content

**Find this in your dashboard.html:**
```html
      <!-- Alo Activity Tab -->
      <div class="tab-content" id="tab-activity">
        <div class="card">
          <div class="card-header">
            <span class="card-title">Recent Conversations</span>
          </div>
          <div class="card-body" id="activityExcerpts">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>
```

**Replace with:**
```html
      <!-- Alo Activity Tab -->
      <div class="tab-content" id="tab-activity">
        <!-- Messages from Client (NEW) -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Messages from Client</span>
          </div>
          <div class="card-body" id="activityMessagesContainer">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
        
        <!-- Recent Conversations (existing) -->
        <div class="card">
          <div class="card-header">
            <span class="card-title">Recent Conversations</span>
          </div>
          <div class="card-body" id="activityExcerpts">
            <div class="loading"><div class="spinner"></div></div>
          </div>
        </div>
      </div>
```

---

## PART 3: Make Therapist Name Editable

### C. Update Header HTML

**Find this in your dashboard.html:**
```html
    <div class="header-right">
      <span class="user-name">Dr. Dupree</span>
      <div class="user-avatar">D</div>
    </div>
```

**Replace with:**
```html
    <div class="header-right">
      <span class="user-name" id="therapistName" 
            onclick="editTherapistName()" 
            style="cursor: pointer;" 
            title="Click to edit your name">
        Dr. Dupree
      </span>
      <div class="user-avatar" id="therapistAvatar">D</div>
    </div>
```

---

## PART 4: JavaScript Functions

### D. Add These Functions to Your <script> Section

**Find your JavaScript section that starts with:**
```javascript
    document.addEventListener('DOMContentLoaded', loadDashboard);
```

**Replace it with:**
```javascript
    document.addEventListener('DOMContentLoaded', () => {
      loadTherapistName();
      loadDashboard();
    });
```

**Then add these NEW functions anywhere in your <script> section:**

```javascript
    // =====================================================
    // THERAPIST NAME FUNCTIONS (NEW)
    // =====================================================
    function loadTherapistName() {
      const saved = localStorage.getItem('therapistName') || 'Dr. Dupree';
      document.getElementById('therapistName').textContent = saved;
      
      // Update avatar
      const initials = saved.split(' ')
        .map(n => n[0])
        .join('')
        .substring(0, 2)
        .toUpperCase();
      document.getElementById('therapistAvatar').textContent = initials;
    }

    function editTherapistName() {
      const current = localStorage.getItem('therapistName') || 'Dr. Dupree';
      const newName = prompt('Enter your name:', current);
      
      if (newName && newName.trim()) {
        localStorage.setItem('therapistName', newName.trim());
        loadTherapistName();
        toast('Name updated');
      }
    }
    
    // =====================================================
    // MESSAGES FUNCTIONS (NEW)
    // =====================================================
    async function loadMessages() {
      try {
        // Get all recent messages
        const allMessages = await api(`/rest/v1/client_messages?order=created_at.desc&limit=20`);
        
        // Filter to only messages from our clients
        const clientMessages = allMessages?.filter(m => 
          allClients.some(c => c.client_code === m.client_code)
        ) || [];
        
        renderMessages(clientMessages);
      } catch (err) {
        console.error('Error loading messages:', err);
        document.getElementById('messagesList').innerHTML = 
          '<div class="section-empty">Error loading messages</div>';
      }
    }
    
    function renderMessages(messages) {
      document.getElementById('messagesCount').textContent = messages.length;
      
      if (!messages.length) {
        document.getElementById('messagesList').innerHTML = 
          '<div class="section-empty">No messages from clients yet</div>';
        return;
      }
      
      document.getElementById('messagesList').innerHTML = messages.map(m => {
        const client = allClients.find(c => c.client_code === m.client_code);
        const displayName = client?.display_name || m.client_code;
        
        return `
          <div class="list-item" onclick="showClient('${m.client_code}')">
            <div class="list-item-indicator" style="background: #3b82f6;"></div>
            <div class="list-item-content">
              <div class="list-item-title">${displayName}</div>
              <div class="list-item-description">${truncate(m.message, 80)}</div>
            </div>
            <span class="list-item-meta">${timeAgo(new Date(m.created_at))}</span>
            <button class="list-item-action">View</button>
          </div>
        `;
      }).join('');
    }
```

### E. Update loadDashboard() Function

**Find this line in your `loadDashboard()` function:**
```javascript
        renderAlerts();
        renderTriage();
        renderClientsList();
```

**Change it to:**
```javascript
        renderAlerts();
        renderTriage();
        loadMessages(); // NEW: Load messages section
        renderClientsList();
```

### F. Update loadClientData() Function

**Find the section that loads clientMessages in `loadClientData()`:**
```javascript
        const [turns, homework, clientMessages] = await Promise.all([
          api(`/rest/v1/conversation_turns?user_id=eq.${code}&order=created_at.desc&limit=15`),
          api(`/rest/v1/homework?client_code=eq.${code}&order=created_at.desc`),
          api(`/rest/v1/client_messages?client_code=eq.${code}&order=created_at.desc&limit=10`)
        ]);
```

**After this section, find where it loads activity excerpts and add this BEFORE it:**

```javascript
        // Display client messages in Alo Activity tab (NEW)
        if (clientMessages?.length) {
          document.getElementById('activityMessagesContainer').innerHTML = clientMessages.map(m => `
            <div class="excerpt">
              <div class="excerpt-time">${timeAgo(new Date(m.created_at))}</div>
              <div class="excerpt-text">"${truncate(m.message, 300)}"</div>
            </div>
          `).join('');
        } else {
          document.getElementById('activityMessagesContainer').innerHTML = 
            '<p style="color: var(--text-muted); text-align: center;">No messages from client</p>';
        }
```

---

## TESTING CHECKLIST

### Test 1: Messages on Homepage
1. âœ… Open dashboard
2. âœ… Should see 3 sections: Alerts, Triage, **Messages from Clients** (NEW)
3. âœ… Messages count shows number
4. âœ… Click message â†’ goes to that client

### Test 2: Messages in Alo Activity
1. âœ… Open dashboard â†’ click client
2. âœ… Go to "Alo Activity" tab
3. âœ… Should see 2 cards: **Messages from Client** (NEW) and Recent Conversations
4. âœ… Messages display with timestamps

### Test 3: Editable Therapist Name
1. âœ… Open dashboard
2. âœ… Click on "Dr. Dupree" in top right
3. âœ… Popup appears asking for name
4. âœ… Enter your name â†’ saves
5. âœ… Avatar updates with initials
6. âœ… Reload page â†’ name persists

---

## VISUAL LAYOUT

### Homepage Before:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Alerts                   â”‚
â”‚ 2. Clinical Triage          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Homepage After:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Alerts                   â”‚
â”‚ 2. Clinical Triage          â”‚
â”‚ 3. Messages from Clients â­ â”‚ â† NEW!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alo Activity Tab Before:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Recent Conversations        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Alo Activity Tab After:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Messages from Client      â­â”‚ â† NEW!
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recent Conversations        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## COMPLETE IMPLEMENTATION ORDER

1. **Add Messages HTML to homepage** (Part 1, Section A)
2. **Update Alo Activity tab HTML** (Part 2, Section B)
3. **Update header for editable name** (Part 3, Section C)
4. **Add therapist name functions** (Part 4, Section D)
5. **Add messages functions** (Part 4, Section D)
6. **Update loadDashboard()** (Part 4, Section E)
7. **Update loadClientData()** (Part 4, Section F)
8. **Test everything!**

---

## QUICK COPY-PASTE SUMMARY

**3 HTML Changes:**
1. Homepage: Add messages section after triage
2. Alo Activity: Add messages card before conversations
3. Header: Make therapist name clickable

**4 JavaScript Changes:**
1. Add `loadTherapistName()` and `editTherapistName()` functions
2. Add `loadMessages()` and `renderMessages()` functions
3. Update `loadDashboard()` to call `loadMessages()`
4. Update `loadClientData()` to populate activity messages

**Result:**
- âœ… Messages show on homepage (3rd section)
- âœ… Messages show in Alo Activity tab (top card)
- âœ… Therapist name is editable (click header)
- âœ… Everything connects to Supabase

---

All done! These changes will add the messages sections and editable therapist name to your dashboard. Let me know if you need any clarification on where to add these! ğŸš€
