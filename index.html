<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alo — Therapist Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #FAFAFA;
      --card: #FFFFFF;
      --primary: #52796F;
      --primary-light: #E8F0ED;
      --text: #1A1A1A;
      --text-muted: #6B7280;
      --border: #E5E7EB;
      --warning: #F59E0B;
      --warning-bg: #FEF3C7;
      --danger: #EF4444;
      --danger-bg: #FEE2E2;
      --success: #10B981;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); }
    
    /* Header */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo { font-size: 1.25rem; font-weight: 600; color: var(--primary); display: flex; align-items: center; gap: 0.5rem; }
    .logo-icon { width: 32px; height: 32px; background: var(--primary); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .logo-icon svg { width: 20px; height: 20px; color: white; }
    .user-info { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
    .user-name { font-size: 0.875rem; color: var(--text-muted); }
    .user-avatar { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; }
    
    /* Layout */
    .layout { display: grid; grid-template-columns: 1fr 300px; gap: 1.5rem; padding: 1.5rem 2rem; max-width: 1400px; margin: 0 auto; }
    .main { display: flex; flex-direction: column; gap: 1.5rem; }
    .sidebar { display: flex; flex-direction: column; gap: 1rem; }
    
    /* Cards */
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
    .card-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .card-title { font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem; }
    .card-body { padding: 1rem 1.25rem; }
    .card-count { background: var(--primary-light); color: var(--primary); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600; }
    
    /* Sections */
    .section { background: var(--card); border: 1px solid var(--border); border-radius: 12px; }
    .section-header { padding: 1rem 1.25rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 0.75rem; }
    .section-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
    .section-icon svg { width: 18px; height: 18px; }
    .section-icon.danger { background: var(--danger-bg); color: var(--danger); }
    .section-icon.warning { background: var(--warning-bg); color: var(--warning); }
    .section-icon.primary { background: var(--primary-light); color: var(--primary); }
    .section-title { font-weight: 600; font-size: 0.9rem; flex: 1; }
    .section-count { background: var(--bg); padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.75rem; color: var(--text-muted); }
    .section-body { padding: 0.5rem; }
    .section-empty { padding: 1.5rem; text-align: center; color: var(--text-muted); font-size: 0.875rem; }
    
    /* List Items */
    .list-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; cursor: pointer; transition: background 0.15s; }
    .list-item:hover { background: var(--bg); }
    .list-item-indicator { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .list-item-indicator.danger { background: var(--danger); }
    .list-item-indicator.warning { background: var(--warning); }
    .list-item-indicator.primary { background: var(--primary); }
    .list-item-content { flex: 1; min-width: 0; }
    .list-item-title { font-weight: 500; font-size: 0.875rem; }
    .list-item-desc { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.125rem; }
    .list-item-meta { font-size: 0.75rem; color: var(--text-muted); }
    .list-item-action { padding: 0.375rem 0.75rem; background: var(--bg); border: 1px solid var(--border); border-radius: 6px; font-size: 0.75rem; cursor: pointer; }
    .list-item-action:hover { background: var(--primary-light); border-color: var(--primary); color: var(--primary); }
    
    /* Clients Sidebar */
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border); }
    .sidebar-title { font-weight: 600; font-size: 0.9rem; }
    .sidebar-list { max-height: 400px; overflow-y: auto; }
    .client-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid var(--border); }
    .client-item:hover { background: var(--bg); }
    .client-item.active { background: var(--primary-light); }
    .client-avatar { width: 36px; height: 36px; background: var(--primary-light); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 0.75rem; position: relative; }
    .client-info { flex: 1; min-width: 0; }
    .client-name { font-weight: 500; font-size: 0.875rem; }
    .client-meta { font-size: 0.7rem; color: var(--text-muted); }
    .status-badge { width: 10px; height: 10px; border-radius: 50%; position: absolute; bottom: 0; right: 0; border: 2px solid white; }
    .status-badge.crisis { background: var(--danger); }
    .status-badge.active { background: var(--success); }
    .status-badge.quiet { background: var(--text-muted); }
    
    /* Buttons */
    .btn { padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.875rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.15s; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { opacity: 0.9; }
    .btn-sm { padding: 0.375rem 0.75rem; font-size: 0.75rem; }
    
    /* Client Page */
    .client-page { display: none; }
    .client-page.active { display: grid; }
    .page-header { margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: flex-start; }
    .page-title { font-size: 1.5rem; font-weight: 600; }
    .page-meta { font-size: 0.875rem; color: var(--text-muted); margin-top: 0.25rem; cursor: pointer; }
    .page-meta:hover { color: var(--primary); }
    
    /* Tabs */
    .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border); padding-bottom: 0.5rem; }
    .tab { padding: 0.5rem 1rem; background: none; border: none; font-size: 0.875rem; color: var(--text-muted); cursor: pointer; border-radius: 6px; }
    .tab:hover { color: var(--text); background: var(--bg); }
    .tab.active { color: var(--primary); background: var(--primary-light); font-weight: 500; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Forms */
    .form-group { margin-bottom: 1rem; }
    .form-label { display: block; font-size: 0.75rem; font-weight: 500; color: var(--text-muted); margin-bottom: 0.375rem; text-transform: uppercase; letter-spacing: 0.025em; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 0.625rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.875rem; font-family: inherit; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); }
    .form-textarea { min-height: 100px; resize: vertical; }
    
    /* Homework */
    .homework-item { display: flex; align-items: flex-start; gap: 0.75rem; padding: 0.75rem 0; border-bottom: 1px solid var(--border); }
    .homework-item:last-child { border-bottom: none; }
    .homework-status { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .homework-status.active { background: var(--warning-bg); color: var(--warning); }
    .homework-status.completed { background: var(--primary-light); color: var(--primary); }
    .homework-status svg { width: 14px; height: 14px; }
    .homework-content { flex: 1; }
    .homework-type { font-weight: 500; font-size: 0.875rem; }
    .homework-desc { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.125rem; }
    .homework-meta { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }
    
    /* Session Notes */
    .notes-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .notes-textarea { width: 100%; min-height: 150px; padding: 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-family: inherit; font-size: 0.875rem; resize: vertical; }
    .notes-textarea:focus { outline: none; border-color: var(--primary); }
    
    /* Loading */
    .loading { display: flex; align-items: center; justify-content: center; padding: 2rem; gap: 0.5rem; color: var(--text-muted); }
    .spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Toast */
    .toast { position: fixed; bottom: 1.5rem; right: 1.5rem; background: var(--text); color: white; padding: 0.75rem 1.25rem; border-radius: 8px; font-size: 0.875rem; z-index: 1000; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: white; border-radius: 12px; padding: 1.5rem; width: 100%; max-width: 400px; }
    .modal-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; }
    .modal-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; }
    
    /* Responsive */
    @media (max-width: 900px) {
      .layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
      </div>
      Alo
    </div>
    <div class="user-info" onclick="editTherapistName()">
      <span class="user-name" id="therapistName">Dr. Dupree</span>
      <div class="user-avatar" id="therapistAvatar">D</div>
    </div>
  </header>

  <!-- Home Page -->
  <div class="layout" id="homePage">
    <div class="main">
      <!-- Alerts -->
      <div class="section">
        <div class="section-header">
          <div class="section-icon danger">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 9v2m0 4h.01M12 3l9 16H3L12 3z"/></svg>
          </div>
          <span class="section-title">Alerts</span>
          <span class="section-count" id="alertsCount">0</span>
        </div>
        <div class="section-body" id="alertsList">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
      
      <!-- Triage -->
      <div class="section">
        <div class="section-header">
          <div class="section-icon warning">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
          </div>
          <span class="section-title">Clinical Triage</span>
          <span class="section-count" id="triageCount">0</span>
        </div>
        <div class="section-body" id="triageList">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
      
      <!-- Client Messages -->
      <div class="section">
        <div class="section-header">
          <div class="section-icon primary">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"/></svg>
          </div>
          <span class="section-title">Client Messages</span>
          <span class="section-count" id="messagesCount">0</span>
        </div>
        <div class="section-body" id="messagesList">
          <div class="loading"><div class="spinner"></div>Loading...</div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <div class="sidebar-header">
          <span class="sidebar-title">Clients</span>
          <button class="btn btn-primary btn-sm" onclick="showAddClientModal()">+ Add</button>
        </div>
        <div class="sidebar-list" id="clientsList"></div>
      </div>
    </div>
  </div>

  <!-- Client Page (hidden by default) -->
  <div class="layout client-page" id="clientPage">
    <div class="main">
      <div class="page-header">
        <div>
          <h1 class="page-title" id="clientName">Client Name</h1>
          <p class="page-meta" id="clientCode" onclick="copyClientCode()">Click to copy code</p>
        </div>
        <button class="btn" onclick="goHome()" style="background: var(--bg); border: 1px solid var(--border);">← Back</button>
      </div>
      
      <div class="tabs">
        <button class="tab active" onclick="switchTab('prep', this)">Session Prep</button>
        <button class="tab" onclick="switchTab('homework', this)">Homework</button>
        <button class="tab" onclick="switchTab('activity', this)">Alo Activity</button>
        <button class="tab" onclick="switchTab('notes', this)">Session Notes</button>
      </div>
      
      <!-- Session Prep Tab -->
      <div class="tab-content active" id="tab-prep">
        <div class="card">
          <div class="card-header"><span class="card-title">Pre-Session Brief</span></div>
          <div class="card-body" id="prepBrief">Loading...</div>
        </div>
      </div>
      
      <!-- Homework Tab -->
      <div class="tab-content" id="tab-homework">
        <div class="card" style="margin-bottom: 1rem;">
          <div class="card-header"><span class="card-title">Assign New Homework</span></div>
          <div class="card-body">
            <div class="form-group">
              <label class="form-label">Type</label>
              <select class="form-select" id="homeworkType">
                <option value="Reflection">Reflection</option>
                <option value="Journaling">Journaling</option>
                <option value="Behavior">Behavior Practice</option>
                <option value="Reading">Reading</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Description</label>
              <textarea class="form-textarea" id="homeworkDesc" placeholder="What should they work on?"></textarea>
            </div>
            <button class="btn btn-primary" onclick="assignHomework()">Assign Homework</button>
          </div>
        </div>
        <div class="card">
          <div class="card-header"><span class="card-title">Homework History</span></div>
          <div class="card-body" id="homeworkList">Loading...</div>
        </div>
      </div>
      
      <!-- Alo Activity Tab -->
      <div class="tab-content" id="tab-activity">
        <div class="card">
          <div class="card-header"><span class="card-title">Messages from Client</span></div>
          <div class="card-body" id="clientMessages">Loading...</div>
        </div>
      </div>
      
      <!-- Session Notes Tab -->
      <div class="tab-content" id="tab-notes">
        <div class="card">
          <div class="card-header"><span class="card-title">Your Session Notes</span></div>
          <div class="card-body">
            <textarea class="notes-textarea" id="sessionNotes" placeholder="Notes for this client..."></textarea>
            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
              <button class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
              <button class="btn" style="background: var(--bg); border: 1px solid var(--border);" onclick="copyNotes()">Copy Notes</button>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="card">
        <div class="sidebar-header">
          <span class="sidebar-title">Clients</span>
          <button class="btn btn-primary btn-sm" onclick="showAddClientModal()">+ Add</button>
        </div>
        <div class="sidebar-list" id="clientsList2"></div>
      </div>
    </div>
  </div>

  <!-- Add Client Modal -->
  <div class="modal-overlay" id="addClientModal" style="display: none;">
    <div class="modal">
      <h3 class="modal-title">Add New Client</h3>
      <div class="form-group">
        <label class="form-label">Client Code</label>
        <input type="text" class="form-input" id="newClientCode" placeholder="e.g., JohnD-001">
      </div>
      <div class="form-group">
        <label class="form-label">Display Name (optional)</label>
        <input type="text" class="form-input" id="newClientName" placeholder="e.g., John D.">
      </div>
      <div class="modal-actions">
        <button class="btn" style="background: var(--bg); border: 1px solid var(--border);" onclick="hideAddClientModal()">Cancel</button>
        <button class="btn btn-primary" onclick="addClient()">Add Client</button>
      </div>
    </div>
  </div>

  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';
    const THERAPIST_ID = 'dupree-001';

    // =====================================================
    // STATE
    // =====================================================
    let allClients = [];
    let currentClient = null;

    // =====================================================
    // INIT
    // =====================================================
    document.addEventListener('DOMContentLoaded', loadDashboard);

    // =====================================================
    // API HELPER
    // =====================================================
    async function api(endpoint) {
      const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      });
      if (!res.ok) throw new Error(`API Error: ${res.status}`);
      return res.json();
    }

    async function apiPost(endpoint, data) {
      const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
        method: 'POST',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`API Error: ${res.status}`);
      return res.json();
    }

    async function apiPatch(endpoint, data) {
      const res = await fetch(`${SUPABASE_URL}${endpoint}`, {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(data)
      });
      if (!res.ok) throw new Error(`API Error: ${res.status}`);
    }

    // =====================================================
    // LOAD DASHBOARD
    // =====================================================
    async function loadDashboard() {
      loadTherapistName();
      
      try {
        // Load clients
        const links = await api(`/rest/v1/therapist_client_links?therapist_id=eq.${THERAPIST_ID}&select=*`);
        
        if (!links?.length) {
          document.getElementById('alertsList').innerHTML = '<div class="section-empty">No alerts</div>';
          document.getElementById('triageList').innerHTML = '<div class="section-empty">No items</div>';
          document.getElementById('messagesList').innerHTML = '<div class="section-empty">No messages</div>';
          document.getElementById('clientsList').innerHTML = '<div class="section-empty" style="padding: 1rem;">No clients yet. Click + Add to add one.</div>';
          return;
        }
        
        // Enrich with stats
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        
        allClients = await Promise.all(links.map(async (client) => {
          const [recent, hw] = await Promise.all([
            api(`/rest/v1/conversation_turns?user_id=eq.${client.client_code}&created_at=gte.${weekAgo}&select=id,intention_chosen,created_at`),
            api(`/rest/v1/homework?client_code=eq.${client.client_code}&active=eq.true&select=id`)
          ]);
          
          const hasCrisis = recent?.some(t => t.intention_chosen === 'CRISIS');
          const messages = recent?.length || 0;
          const homework = hw?.length || 0;
          const lastActivity = recent?.length ? recent[0].created_at : null;
          
          let status = 'quiet';
          if (hasCrisis) status = 'crisis';
          else if (messages > 0) status = 'active';
          
          return { ...client, hasCrisis, messages, homework, lastActivity, status };
        }));
        
        renderAlerts();
        renderTriage();
        renderClientsList();
        loadMessages();
        
      } catch (err) {
        console.error('Dashboard error:', err);
        document.getElementById('alertsList').innerHTML = `<div class="section-empty">Error: ${err.message}</div>`;
      }
    }

    // =====================================================
    // RENDER FUNCTIONS
    // =====================================================
    function renderAlerts() {
      const alerts = allClients.filter(c => c.hasCrisis);
      document.getElementById('alertsCount').textContent = alerts.length;
      
      if (!alerts.length) {
        document.getElementById('alertsList').innerHTML = '<div class="section-empty">No crisis alerts</div>';
        return;
      }
      
      document.getElementById('alertsList').innerHTML = alerts.map(c => `
        <div class="list-item" onclick="showClient('${c.client_code}')">
          <div class="list-item-indicator danger"></div>
          <div class="list-item-content">
            <div class="list-item-title">${c.display_name || c.client_code}</div>
            <div class="list-item-desc">Crisis detected in recent conversation</div>
          </div>
          <button class="list-item-action">Review</button>
        </div>
      `).join('');
    }

    function renderTriage() {
      const triage = allClients.filter(c => !c.hasCrisis && (c.homework > 0 && c.messages === 0));
      document.getElementById('triageCount').textContent = triage.length;
      
      if (!triage.length) {
        document.getElementById('triageList').innerHTML = '<div class="section-empty">All clients stable</div>';
        return;
      }
      
      document.getElementById('triageList').innerHTML = triage.map(c => `
        <div class="list-item" onclick="showClient('${c.client_code}')">
          <div class="list-item-indicator warning"></div>
          <div class="list-item-content">
            <div class="list-item-title">${c.display_name || c.client_code}</div>
            <div class="list-item-desc">Has homework but no Alo activity this week</div>
          </div>
          <button class="list-item-action">Review</button>
        </div>
      `).join('');
    }

    async function loadMessages() {
      try {
        const messages = await api(`/rest/v1/client_messages?read_by_therapist=eq.false&order=created_at.desc&limit=20`);
        document.getElementById('messagesCount').textContent = messages?.length || 0;
        
        if (!messages?.length) {
          document.getElementById('messagesList').innerHTML = '<div class="section-empty">No new messages</div>';
          return;
        }
        
        document.getElementById('messagesList').innerHTML = messages.map(m => `
          <div class="list-item">
            <div class="list-item-indicator primary"></div>
            <div class="list-item-content">
              <div class="list-item-title">${m.client_code}</div>
              <div class="list-item-desc">${truncate(m.message, 80)}</div>
            </div>
            <span class="list-item-meta">${timeAgo(new Date(m.created_at))}</span>
            <button class="list-item-action" onclick="event.stopPropagation(); markRead('${m.id}')">Read</button>
          </div>
        `).join('');
      } catch (err) {
        document.getElementById('messagesList').innerHTML = '<div class="section-empty">Could not load messages</div>';
      }
    }

    async function markRead(id) {
      await apiPatch(`/rest/v1/client_messages?id=eq.${id}`, { read_by_therapist: true });
      loadMessages();
      toast('Marked as read');
    }

    function renderClientsList() {
      const html = allClients.map(c => `
        <div class="client-item ${currentClient === c.client_code ? 'active' : ''}" onclick="showClient('${c.client_code}')">
          <div class="client-avatar">
            ${(c.display_name || c.client_code).substring(0, 2).toUpperCase()}
            <div class="status-badge ${c.status}"></div>
          </div>
          <div class="client-info">
            <div class="client-name">${c.display_name || c.client_code}</div>
            <div class="client-meta">${c.messages} msgs · ${c.homework} hw</div>
          </div>
        </div>
      `).join('');
      
      document.getElementById('clientsList').innerHTML = html || '<div class="section-empty" style="padding: 1rem;">No clients yet</div>';
      document.getElementById('clientsList2').innerHTML = html;
    }

    // =====================================================
    // CLIENT PAGE
    // =====================================================
    async function showClient(code) {
      currentClient = code;
      document.getElementById('homePage').style.display = 'none';
      document.getElementById('clientPage').classList.add('active');
      
      const client = allClients.find(c => c.client_code === code);
      document.getElementById('clientName').textContent = client?.display_name || code;
      document.getElementById('clientCode').textContent = code + ' (click to copy)';
      
      renderClientsList();
      
      // Load client data
      const [hw, messages] = await Promise.all([
        api(`/rest/v1/homework?client_code=eq.${code}&order=created_at.desc`),
        api(`/rest/v1/client_messages?client_code=eq.${code}&order=created_at.desc&limit=10`)
      ]);
      
      // Prep brief
      document.getElementById('prepBrief').innerHTML = `
        <p><strong>${client?.display_name || code}</strong> has ${client?.messages || 0} Alo conversations this week and ${client?.homework || 0} active homework items.</p>
        ${client?.hasCrisis ? '<p style="color: var(--danger); font-weight: 500;">⚠️ Crisis detected in recent conversation</p>' : ''}
      `;
      
      // Homework
      if (hw?.length) {
        document.getElementById('homeworkList').innerHTML = hw.map(h => `
          <div class="homework-item">
            <div class="homework-status ${h.active ? 'active' : 'completed'}">
              ${h.active ? '⏳' : '✓'}
            </div>
            <div class="homework-content">
              <div class="homework-type">${h.homework_type}</div>
              <div class="homework-desc">${h.description}</div>
              <div class="homework-meta">Assigned ${timeAgo(new Date(h.created_at))}</div>
            </div>
            ${h.active ? `<button class="btn btn-sm" style="background: var(--bg); border: 1px solid var(--border);" onclick="completeHomework('${h.id}')">Complete</button>` : ''}
          </div>
        `).join('');
      } else {
        document.getElementById('homeworkList').innerHTML = '<p style="color: var(--text-muted);">No homework assigned yet</p>';
      }
      
      // Messages
      if (messages?.length) {
        document.getElementById('clientMessages').innerHTML = messages.map(m => `
          <div style="padding: 0.75rem; background: ${m.read_by_therapist ? 'var(--bg)' : 'var(--warning-bg)'}; border-radius: 8px; margin-bottom: 0.5rem;">
            <p style="font-size: 0.875rem;">${m.message}</p>
            <p style="font-size: 0.7rem; color: var(--text-muted); margin-top: 0.5rem;">${timeAgo(new Date(m.created_at))} ${!m.read_by_therapist ? '• New' : ''}</p>
          </div>
        `).join('');
      } else {
        document.getElementById('clientMessages').innerHTML = '<p style="color: var(--text-muted);">No messages from client</p>';
      }
      
      // Load notes
      const savedNotes = localStorage.getItem(`aloNotes_therapist_${code}`);
      document.getElementById('sessionNotes').value = savedNotes || '';
    }

    function goHome() {
      currentClient = null;
      document.getElementById('clientPage').classList.remove('active');
      document.getElementById('homePage').style.display = 'grid';
      renderClientsList();
    }

    // =====================================================
    // TABS
    // =====================================================
    function switchTab(tabName, btn) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById(`tab-${tabName}`).classList.add('active');
    }

    // =====================================================
    // HOMEWORK
    // =====================================================
    async function assignHomework() {
      const type = document.getElementById('homeworkType').value;
      const desc = document.getElementById('homeworkDesc').value.trim();
      
      if (!desc) { alert('Please enter a description'); return; }
      
      await apiPost('/rest/v1/homework', {
        client_code: currentClient,
        homework_type: type,
        description: desc,
        active: true,
        assigned_date: new Date().toISOString()
      });
      
      document.getElementById('homeworkDesc').value = '';
      toast('Homework assigned');
      showClient(currentClient);
    }

    async function completeHomework(id) {
      await apiPatch(`/rest/v1/homework?id=eq.${id}`, { active: false });
      toast('Marked complete');
      showClient(currentClient);
    }

    // =====================================================
    // NOTES
    // =====================================================
    function saveNotes() {
      const notes = document.getElementById('sessionNotes').value;
      localStorage.setItem(`aloNotes_therapist_${currentClient}`, notes);
      toast('Notes saved');
    }

    function copyNotes() {
      const notes = document.getElementById('sessionNotes').value;
      navigator.clipboard.writeText(notes);
      toast('Notes copied');
    }

    // =====================================================
    // CLIENTS
    // =====================================================
    function showAddClientModal() {
      document.getElementById('addClientModal').style.display = 'flex';
    }

    function hideAddClientModal() {
      document.getElementById('addClientModal').style.display = 'none';
      document.getElementById('newClientCode').value = '';
      document.getElementById('newClientName').value = '';
    }

    async function addClient() {
      const code = document.getElementById('newClientCode').value.trim();
      const name = document.getElementById('newClientName').value.trim();
      
      if (!code) { alert('Please enter a client code'); return; }
      
      await apiPost('/rest/v1/therapist_client_links', {
        therapist_id: THERAPIST_ID,
        client_code: code,
        display_name: name || null
      });
      
      hideAddClientModal();
      toast('Client added');
      loadDashboard();
    }

    function copyClientCode() {
      navigator.clipboard.writeText(currentClient);
      toast('Code copied: ' + currentClient);
    }

    // =====================================================
    // THERAPIST NAME
    // =====================================================
    function loadTherapistName() {
      const name = localStorage.getItem('aloTherapistName') || 'Dr. Dupree';
      document.getElementById('therapistName').textContent = name;
      document.getElementById('therapistAvatar').textContent = name.charAt(0).toUpperCase();
    }

    function editTherapistName() {
      const name = prompt('Enter your name:', localStorage.getItem('aloTherapistName') || 'Dr. Dupree');
      if (name) {
        localStorage.setItem('aloTherapistName', name);
        loadTherapistName();
      }
    }

    // =====================================================
    // UTILITIES
    // =====================================================
    function timeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    function truncate(str, len) {
      if (!str) return '';
      return str.length > len ? str.substring(0, len) + '...' : str;
    }

    function toast(msg) {
      const t = document.createElement('div');
      t.className = 'toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 3000);
    }
  </script>
</body>
</html>
