<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alo Therapist Dashboard - Dupree</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --primary: #4F46E5;
      --primary-dark: #4338CA;
      --success: #10B981;
      --warning: #F59E0B;
      --danger: #EF4444;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-900: #111827;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.6;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }
    
    h1 {
      font-size: 28px;
      color: var(--gray-900);
      font-weight: 700;
    }
    
    .subtitle {
      color: var(--gray-600);
      font-size: 14px;
      margin-top: 4px;
    }
    
    .last-reviewed {
      font-size: 13px;
      color: var(--gray-600);
    }
    
    .btn-mark-reviewed {
      background: var(--primary);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    
    .btn-mark-reviewed:hover {
      background: var(--primary-dark);
    }
    
    .btn-mark-reviewed:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--gray-600);
      margin-top: 4px;
    }
    
    .stat-card.alert {
      border-left: 4px solid var(--danger);
    }
    
    .stat-card.alert .stat-value {
      color: var(--danger);
    }
    
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 12px 24px;
      background: white;
      border: 2px solid var(--gray-200);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      color: var(--gray-600);
      transition: all 0.2s;
    }
    
    .tab:hover {
      border-color: var(--gray-300);
    }
    
    .tab.active {
      background: var(--primary);
      border-color: var(--primary);
      color: white;
    }
    
    .panel {
      display: none;
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .panel.active {
      display: block;
    }
    
    .panel h2 {
      font-size: 20px;
      margin-bottom: 20px;
      color: var(--gray-900);
    }
    
    .client-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .client-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      background: var(--gray-50);
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .client-card:hover {
      background: var(--gray-100);
    }
    
    .client-info h3 {
      font-size: 16px;
      font-weight: 600;
    }
    
    .client-info p {
      font-size: 13px;
      color: var(--gray-600);
      margin-top: 2px;
    }
    
    .client-stats {
      display: flex;
      gap: 16px;
      align-items: center;
    }
    
    .client-stat {
      text-align: center;
    }
    
    .client-stat-value {
      font-size: 18px;
      font-weight: 700;
    }
    
    .client-stat-label {
      font-size: 11px;
      color: var(--gray-600);
      text-transform: uppercase;
    }
    
    .engagement-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .engagement-badge.active {
      background: #D1FAE5;
      color: #065F46;
    }
    
    .engagement-badge.moderate {
      background: #FEF3C7;
      color: #92400E;
    }
    
    .engagement-badge.low {
      background: #FEE2E2;
      color: #991B1B;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 6px;
      color: var(--gray-700);
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 8px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .btn-submit {
      background: var(--success);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .btn-submit:hover {
      background: #059669;
    }
    
    .btn-submit:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .alert-item {
      padding: 16px;
      background: #FEF2F2;
      border-left: 4px solid var(--danger);
      border-radius: 0 8px 8px 0;
      margin-bottom: 12px;
    }
    
    .alert-item.warning {
      background: #FFFBEB;
      border-color: var(--warning);
    }
    
    .alert-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .alert-client {
      font-weight: 600;
    }
    
    .alert-time {
      font-size: 12px;
      color: var(--gray-600);
    }
    
    .alert-message {
      font-size: 14px;
      color: var(--gray-700);
      font-style: italic;
    }
    
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .modal-overlay.active {
      display: flex;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      max-width: 600px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      padding: 24px;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .modal-header h2 {
      margin: 0;
    }
    
    .btn-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--gray-600);
    }
    
    .session-prep {
      background: var(--gray-50);
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    
    .session-prep h4 {
      font-size: 14px;
      color: var(--gray-600);
      margin-bottom: 8px;
    }
    
    .session-prep p {
      font-size: 15px;
    }
    
    .success-message {
      display: none;
      background: #D1FAE5;
      color: #065F46;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-weight: 500;
    }
    
    .success-message.show {
      display: block;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-600);
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--gray-600);
    }
    
    .empty-state p {
      margin-bottom: 8px;
    }

    .homework-item {
      padding: 16px;
      background: var(--gray-50);
      border-radius: 8px;
      margin-bottom: 12px;
    }
    
    .homework-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }
    
    .homework-type {
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .homework-status {
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .homework-status.pending {
      background: #FEF3C7;
      color: #92400E;
    }
    
    .homework-status.engaged {
      background: #D1FAE5;
      color: #065F46;
    }
    
    .homework-description {
      font-size: 14px;
      color: var(--gray-700);
    }
    
    .homework-meta {
      font-size: 12px;
      color: var(--gray-600);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>Alo Therapist Dashboard</h1>
        <p class="subtitle">Client engagement between sessions</p>
      </div>
      <div style="text-align: right;">
        <p class="last-reviewed" id="lastReviewed">Last reviewed: Never</p>
        <button class="btn-mark-reviewed" id="btnMarkReviewed" onclick="markAsReviewed()">
          Mark as Reviewed
        </button>
      </div>
    </header>
    
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="statTotalClients">-</div>
        <div class="stat-label">Total Clients</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statActiveClients">-</div>
        <div class="stat-label">Active This Week</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="statPendingHomework">-</div>
        <div class="stat-label">Pending Homework</div>
      </div>
      <div class="stat-card alert" id="alertCard" style="display: none;">
        <div class="stat-value" id="statAlerts">0</div>
        <div class="stat-label">Recent Alerts</div>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab('clients')">Clients</button>
      <button class="tab" onclick="switchTab('homework')">Assign Homework</button>
      <button class="tab" onclick="switchTab('alerts')">Alerts</button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>
    
    <div class="panel active" id="panel-clients">
      <h2>Your Clients</h2>
      <div class="client-list" id="clientList">
        <div class="loading">Loading clients...</div>
      </div>
    </div>
    
    <div class="panel" id="panel-homework">
      <h2>Assign New Homework</h2>
      <div class="success-message" id="homeworkSuccess">
        ✓ Homework assigned successfully!
      </div>
      <form id="homeworkForm" onsubmit="assignHomework(event)">
        <div class="form-group">
          <label for="clientSelect">Client</label>
          <select id="clientSelect" required>
            <option value="">Select a client...</option>
          </select>
        </div>
        <div class="form-group">
          <label for="homeworkType">Type</label>
          <select id="homeworkType" required>
            <option value="noticing">Noticing Practice</option>
            <option value="behavioral">Behavioral Experiment</option>
            <option value="cognitive">Cognitive Exercise</option>
            <option value="grounding">Grounding Technique</option>
            <option value="journaling">Journaling Prompt</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="form-group">
          <label for="homeworkDescription">Description / Instructions</label>
          <textarea id="homeworkDescription" placeholder="What should the client practice or try?" required></textarea>
        </div>
        <div class="form-group">
          <label for="therapistNotes">Private Notes (client won't see this)</label>
          <textarea id="therapistNotes" placeholder="Optional: Notes for yourself about this homework..."></textarea>
        </div>
        <button type="submit" class="btn-submit" id="btnSubmitHomework">Assign Homework</button>
      </form>
      
      <h2 style="margin-top: 40px;">Active Homework</h2>
      <div id="activeHomeworkList">
        <div class="loading">Loading homework...</div>
      </div>
    </div>
    
    <div class="panel" id="panel-alerts">
      <h2>Recent Alerts</h2>
      <p class="subtitle" style="margin-bottom: 20px;">Crisis signals detected in the past 7 days</p>
      <div id="alertsList">
        <div class="loading">Loading alerts...</div>
      </div>
    </div>
    
    <div class="panel" id="panel-settings">
      <h2>Dashboard Settings</h2>
      <div class="form-group">
        <label>
          <input type="checkbox" id="showHomeworkBarriers" onchange="toggleHomeworkBarriers()">
          Show homework barriers in client list
        </label>
      </div>
      <div class="form-group">
        <label>Therapist ID</label>
        <input type="text" id="therapistIdDisplay" readonly style="background: var(--gray-100);">
      </div>
    </div>
  </div>
  
  <div class="modal-overlay" id="clientModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalClientName">Client Details</h2>
        <button class="btn-close" onclick="closeModal()">&times;</button>
      </div>
      <div id="modalContent">
        <div class="loading">Loading...</div>
      </div>
    </div>
  </div>

  <script>
    // =====================================================
    // CONFIGURATION
    // =====================================================
    const SUPABASE_URL = 'https://lelsdezstbnzyxvsvbyx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlbHNkZXpzdGJuenl4dnN2Ynl4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2MDk1NDUsImV4cCI6MjA3OTE4NTU0NX0.mm1POxfEEoRXyTF08NsUZOau6qA_UdZJnoUH_5bkQas';
    const THERAPIST_ID = '94ebfe1c-57d1-48d8-a165-a9152ded65db';
    
    let clients = [];
    let showBarriers = false;
    
    // =====================================================
    // INITIALIZATION
    // =====================================================
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      loadDashboard();
      document.getElementById('therapistIdDisplay').value = THERAPIST_ID;
    });
    
    // =====================================================
    // API HELPER
    // =====================================================
    async function supabaseCall(endpoint, options = {}) {
      const url = `${SUPABASE_URL}${endpoint}`;
      const headers = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      const response = await fetch(url, { ...options, headers });
      
      if (!response.ok) {
        const error = await response.text();
        throw new Error(`API Error: ${response.status} - ${error}`);
      }
      
      const text = await response.text();
      return text ? JSON.parse(text) : null;
    }
    
    // =====================================================
    // LOAD DASHBOARD
    // =====================================================
    async function loadDashboard() {
      try {
        const stats = await supabaseCall(`/rest/v1/rpc/get_therapist_dashboard`, {
          method: 'POST',
          body: JSON.stringify({ therapist_id_input: THERAPIST_ID })
        });
        
        if (stats && stats.length > 0) {
          const s = stats[0];
          document.getElementById('statTotalClients').textContent = s.total_clients || 0;
          document.getElementById('statActiveClients').textContent = s.active_clients || 0;
          document.getElementById('statPendingHomework').textContent = s.pending_homework || 0;
          
          if (s.recent_alerts > 0) {
            document.getElementById('alertCard').style.display = 'block';
            document.getElementById('statAlerts').textContent = s.recent_alerts;
          }
        }
        
        await loadClients();
        await loadActiveHomework();
        await loadAlerts();
        
      } catch (error) {
        console.error('Dashboard load error:', error);
        document.getElementById('clientList').innerHTML = 
          `<div class="empty-state"><p>Error loading dashboard: ${error.message}</p></div>`;
      }
    }
    
    // =====================================================
    // LOAD CLIENTS
    // =====================================================
    async function loadClients() {
      try {
        const links = await supabaseCall(
          `/rest/v1/therapist_client_links?therapist_id=eq.${THERAPIST_ID}&select=*`
        );
        
        if (!links || links.length === 0) {
          document.getElementById('clientList').innerHTML = 
            `<div class="empty-state">
              <p>No clients linked yet.</p>
              <p>Clients will appear here once they connect.</p>
            </div>`;
          return;
        }
        
        clients = links;
        
        const clientHtml = await Promise.all(links.map(async (client) => {
          const turns = await supabaseCall(
            `/rest/v1/conversation_turns?user_id=eq.${client.client_code}&order=created_at.desc&limit=1`
          );
          
          const lastActive = turns && turns.length > 0 
            ? formatTimeAgo(new Date(turns[0].created_at))
            : 'Never';
          
          const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
          const recentTurns = await supabaseCall(
            `/rest/v1/conversation_turns?user_id=eq.${client.client_code}&created_at=gte.${weekAgo}&select=id`
          );
          
          const turnCount = recentTurns ? recentTurns.length : 0;
          
          let engagementClass, engagementText;
          if (turnCount >= 10) {
            engagementClass = 'active';
            engagementText = 'Active';
          } else if (turnCount >= 3) {
            engagementClass = 'moderate';
            engagementText = 'Moderate';
          } else {
            engagementClass = 'low';
            engagementText = 'Low';
          }
          
          return `
            <div class="client-card" onclick="showClientDetail('${client.client_code}')">
              <div class="client-info">
                <h3>${client.client_code}</h3>
                <p>Last active: ${lastActive}</p>
              </div>
              <div class="client-stats">
                <div class="client-stat">
                  <div class="client-stat-value">${turnCount}</div>
                  <div class="client-stat-label">Messages (7d)</div>
                </div>
                <span class="engagement-badge ${engagementClass}">${engagementText}</span>
              </div>
            </div>
          `;
        }));
        
        document.getElementById('clientList').innerHTML = clientHtml.join('');
        
        const select = document.getElementById('clientSelect');
        select.innerHTML = '<option value="">Select a client...</option>' + 
          links.map(c => `<option value="${c.client_code}">${c.client_code}</option>`).join('');
        
      } catch (error) {
        console.error('Error loading clients:', error);
        document.getElementById('clientList').innerHTML = 
          `<div class="empty-state"><p>Error loading clients: ${error.message}</p></div>`;
      }
    }
    
    // =====================================================
    // LOAD ACTIVE HOMEWORK
    // =====================================================
    async function loadActiveHomework() {
      try {
        const homework = await supabaseCall(
          `/rest/v1/homework?therapist_id=eq.${THERAPIST_ID}&status=eq.active&order=created_at.desc`
        );
        
        const container = document.getElementById('activeHomeworkList');
        
        if (!homework || homework.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No active homework assigned.</p></div>';
          return;
        }
        
        container.innerHTML = homework.map(hw => `
          <div class="homework-item">
            <div class="homework-header">
              <span class="homework-type">${hw.homework_type || 'Custom'} - ${hw.client_code}</span>
              <span class="homework-status pending">Pending</span>
            </div>
            <p class="homework-description">${hw.description}</p>
            <p class="homework-meta">Assigned ${formatTimeAgo(new Date(hw.created_at))}</p>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading homework:', error);
        document.getElementById('activeHomeworkList').innerHTML = 
          `<div class="empty-state"><p>Error loading homework: ${error.message}</p></div>`;
      }
    }
    
    // =====================================================
    // LOAD ALERTS
    // =====================================================
    async function loadAlerts() {
      try {
        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();
        
        const alerts = await supabaseCall(
          `/rest/v1/conversation_turns?intention_chosen=eq.CRISIS&created_at=gte.${weekAgo}&order=created_at.desc&limit=20`
        );
        
        const container = document.getElementById('alertsList');
        
        if (!alerts || alerts.length === 0) {
          container.innerHTML = '<div class="empty-state"><p>No alerts in the past 7 days. ✓</p></div>';
          return;
        }
        
        container.innerHTML = alerts.map(alert => `
          <div class="alert-item">
            <div class="alert-header">
              <span class="alert-client">${alert.user_id || 'Unknown'}</span>
              <span class="alert-time">${formatTimeAgo(new Date(alert.created_at))}</span>
            </div>
            <p class="alert-message">"${truncate(alert.user_message, 150)}"</p>
          </div>
        `).join('');
        
      } catch (error) {
        console.error('Error loading alerts:', error);
        document.getElementById('alertsList').innerHTML = 
          `<div class="empty-state"><p>Error loading alerts: ${error.message}</p></div>`;
      }
    }
    
    // =====================================================
    // ASSIGN HOMEWORK (FIXED)
    // =====================================================
    async function assignHomework(event) {
      event.preventDefault();
      
      const btn = document.getElementById('btnSubmitHomework');
      btn.disabled = true;
      btn.textContent = 'Assigning...';
      
      try {
        const homework = {
          therapist_id: THERAPIST_ID,
          client_code: document.getElementById('clientSelect').value,
          homework_type: document.getElementById('homeworkType').value,
          description: document.getElementById('homeworkDescription').value,
          therapist_notes: document.getElementById('therapistNotes').value || null
        };
        
        const response = await fetch(`${SUPABASE_URL}/rest/v1/homework`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=minimal'
          },
          body: JSON.stringify(homework)
        });
        
        if (!response.ok) {
          const error = await response.text();
          throw new Error(error);
        }
        
        // Success - show message and reset form
        const successMsg = document.getElementById('homeworkSuccess');
        successMsg.classList.add('show');
        document.getElementById('homeworkForm').reset();
        
        // Refresh data
        setTimeout(async () => {
          await loadActiveHomework();
          await loadDashboard();
          successMsg.classList.remove('show');
        }, 2000);
        
      } catch (error) {
        console.error('Error assigning homework:', error);
        alert(`Error: ${error.message}`);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Assign Homework';
      }
    }
    
    // =====================================================
    // CLIENT DETAIL MODAL
    // =====================================================
    async function showClientDetail(clientCode) {
      document.getElementById('modalClientName').textContent = clientCode;
      document.getElementById('clientModal').classList.add('active');
      document.getElementById('modalContent').innerHTML = '<div class="loading">Loading...</div>';
      
      try {
        const recentTurns = await supabaseCall(
          `/rest/v1/conversation_turns?user_id=eq.${clientCode}&order=created_at.desc&limit=10`
        );
        
        const homework = await supabaseCall(
          `/rest/v1/homework?client_code=eq.${clientCode}&status=eq.active`
        );
        
        let html = `
          <div class="session-prep">
            <h4>Session Prep Brief</h4>
            <p><strong>Messages this week:</strong> ${recentTurns ? recentTurns.length : 0}</p>
          </div>
        `;
        
        if (homework && homework.length > 0) {
          html += `
            <div class="session-prep">
              <h4>Active Homework</h4>
              ${homework.map(hw => `
                <p><strong>${hw.homework_type}:</strong> ${hw.description}</p>
              `).join('')}
            </div>
          `;
        }
        
        if (recentTurns && recentTurns.length > 0) {
          html += `
            <div class="session-prep">
              <h4>Recent Conversation Excerpts</h4>
              ${recentTurns.slice(0, 5).map(turn => `
                <p style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px;">
                  <span style="color: var(--gray-600); font-size: 12px;">${formatTimeAgo(new Date(turn.created_at))}</span><br>
                  "${truncate(turn.user_message, 100)}"
                </p>
              `).join('')}
            </div>
          `;
        } else {
          html += `
            <div class="session-prep">
              <h4>Recent Conversations</h4>
              <p>No recent conversations with Alo.</p>
            </div>
          `;
        }
        
        document.getElementById('modalContent').innerHTML = html;
        
      } catch (error) {
        console.error('Error loading client detail:', error);
        document.getElementById('modalContent').innerHTML = 
          `<div class="empty-state"><p>Error: ${error.message}</p></div>`;
      }
    }
    
    function closeModal() {
      document.getElementById('clientModal').classList.remove('active');
    }
    
    document.getElementById('clientModal').addEventListener('click', (e) => {
      if (e.target.id === 'clientModal') closeModal();
    });
    
    // =====================================================
    // MARK AS REVIEWED
    // =====================================================
    async function markAsReviewed() {
      const btn = document.getElementById('btnMarkReviewed');
      btn.disabled = true;
      btn.textContent = 'Marking...';
      
      const now = new Date();
      document.getElementById('lastReviewed').textContent = 
        `Last reviewed: ${now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' })}`;
      
      btn.textContent = '✓ Marked';
      setTimeout(() => {
        btn.textContent = 'Mark as Reviewed';
        btn.disabled = false;
      }, 2000);
    }
    
    // =====================================================
    // TAB SWITCHING
    // =====================================================
    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');
      document.querySelectorAll('.panel').forEach(panel => panel.classList.remove('active'));
      document.getElementById(`panel-${tabName}`).classList.add('active');
    }
    
    // =====================================================
    // SETTINGS
    // =====================================================
    function loadSettings() {
      showBarriers = localStorage.getItem('showHomeworkBarriers') === 'true';
      document.getElementById('showHomeworkBarriers').checked = showBarriers;
    }
    
    function toggleHomeworkBarriers() {
      showBarriers = document.getElementById('showHomeworkBarriers').checked;
      localStorage.setItem('showHomeworkBarriers', showBarriers);
      loadDashboard();
    }
    
    // =====================================================
    // UTILITIES
    // =====================================================
    function formatTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
      if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
      if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    function truncate(str, length) {
      if (!str) return '';
      return str.length > length ? str.substring(0, length) + '...' : str;
    }
  </script>
</body>
</html>
